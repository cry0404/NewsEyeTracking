### 1. feeds 表（RSS源信息表）

| 字段名         | 数据类型                 | 约束条件        | 描述                       |
| -------------- | ------------------------ | --------------- | -------------------------- |
| `id`           | SERIAL (int32)           | PRIMARY KEY     | 主键，自增ID               |
| `title`        | VARCHAR(255)             | NOT NULL        | RSS源标题                  |
| `description`  | TEXT                     | 可为空          | RSS源描述                  |
| `link`         | VARCHAR(512)             | NOT NULL        | RSS源官方链接              |
| `rsshub_route` | VARCHAR(255)             | NOT NULL UNIQUE | RSSHub路由地址（唯一标识） |
| `feed_url`     | VARCHAR(512)             | NOT NULL        | 完整的RSS URL地址          |
| `last_updated` | TIMESTAMP WITH TIME ZONE | 默认NOW()       | 最后更新时间               |
| `is_active`    | BOOLEAN                  | 默认TRUE        | 是否激活状态               |
| `created_at`   | TIMESTAMP WITH TIME ZONE | 默认NOW()       | 创建时间                   |

**索引信息：**

- `idx_feeds_rsshub_route` - rsshub_route字段索引
- `idx_feeds_is_active` - is_active字段索引



**feed 表你不需要太在意，你主要是要处理 feed_items 表，注意 content 里面有很多 html 标签，所以这个分词可能比较麻烦？也许可以试试能不能先提取文字分词后再组装回去？**

### 2. feed_items 表（文章内容表）

| 字段名         | 数据类型                 | 约束条件                                | 描述           |
| -------------- | ------------------------ | --------------------------------------- | -------------- |
| `id`           | SERIAL (int32)           | PRIMARY KEY                             | 主键，自增ID   |
| `feed_id`      | INTEGER                  | FOREIGN KEY → feeds(id), CASCADE DELETE | 关联的RSS源ID  |
| `title`        | VARCHAR(512)             | NOT NULL                                | 文章标题       |
| `description`  | TEXT                     | 可为空                                  | 文章摘要/描述  |
| `content`      | TEXT                     | 可为空                                  | 文章完整内容   |
| `link`         | VARCHAR(512)             | NOT NULL                                | 文章链接       |
| `guid`         | VARCHAR(512)             | NOT NULL UNIQUE                         | 文章唯一标识符 |
| `author`       | VARCHAR(255)             | 可为空                                  | 文章作者       |
| `published_at` | TIMESTAMP WITH TIME ZONE | 可为空                                  | 文章发布时间   |
| `updated_at`   | TIMESTAMP WITH TIME ZONE | 可为空                                  | 文章更新时间   |
| `created_at`   | TIMESTAMP WITH TIME ZONE | 默认NOW()                               | 数据创建时间   |


### 设计总览

1.  **用户模块 (User Module)**: 管理实验参与者的个人信息和登录凭证。
2.  **实验模块 (Experiment Module)**: 定义和管理A/B测试，并将用户分配到不同的实验组。这是实现您A/B Test需求的核心。
3.  **内容模块 (Content Module)**: 存储和管理新闻文章。
4.  **行为日志模块 (Behavior Logging Module)**: 这是数据采集的中心，记录从眼动到点击的所有用户交互事件。

---

### 数据库表详细设计

#### 1. 用户模块

##### `users` - 用户信息表
存储所有注册参与者的详细背景信息。

| 字段名                  | 数据类型     | 约束                        | 备注                                  |
| :---------------------- | :----------- | :-------------------------- | :------------------------------------ |
| `id`                    | INT          | PRIMARY KEY, AUTO_INCREMENT | 用户唯一标识符                        |
| `username`              | VARCHAR(255) | UNIQUE, NOT NULL            | 用户名                                |
| `password_hash`         | VARCHAR(255) | NOT NULL                    | 存储加密后的密码                      |
| `email`                 | VARCHAR(255) | UNIQUE, NOT NULL            | 电子邮箱，用于联系                    |
| `date_of_birth`         | DATE         |                             | 出生年月                              |
| `gender`                | VARCHAR(50)  |                             | 性别                                  |
| `education_level`       | VARCHAR(100) |                             | 学历                                  |
| `residence`             | VARCHAR(255) |                             | 居住地                                |
| `weekly_reading_hours`  | INT          |                             | 每周新闻阅读时长（小时）              |
| `primary_news_platform` | VARCHAR(255) |                             | 经常使用的新闻平台                    |
| `is_active_searcher`    | BOOLEAN      |                             | 是否主动搜索新闻                      |
| `is_colorblind`         | BOOLEAN      |                             | 是否色盲                              |
| `vision_status`         | VARCHAR(50)  |                             | 视力状况 (如: '正常', '近视', '远视') |
| `is_vision_corrected`   | BOOLEAN      |                             | 矫正视力是否正常                      |
| `created_at`            | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP   | 账户创建时间                          |

<br>

##### `invitation_codes` - 邀请码表
管理用于控制用户注册的邀请码。

| 字段名            | 数据类型    | 约束                        | 备注                   |
| :---------------- | :---------- | :-------------------------- | :--------------------- |
| `id`              | INT         | PRIMARY KEY, AUTO_INCREMENT | 邀请码ID               |
| `code`            | VARCHAR(50) | UNIQUE, NOT NULL            | 邀请码字符串           |
| `is_used`         | BOOLEAN     | NOT NULL, DEFAULT FALSE     | 是否已被使用           |
| `used_by_user_id` | INT         | FOREIGN KEY (`users`.`id`)  | 使用该邀请码的用户的ID |
| `created_at`      | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP   | 创建时间               |
|                   |             |                             |                        |

---

## Restful api 设计，数据库设计思考

爬取的时候调用推荐算法： 调用算法接口，从数据库中读取对应的文章

两个推荐： 是否包含收藏评论转发点赞信息，
         是否包含推荐算法
完整的获取新闻流程： 前端向对应端点请求 -> web 服务器收到请求，->返回给前端，标题，描述，以及对应的 feedid

### 新闻获取

User  code  session 

    获取新闻
    /api/v1/news        默认拉取最新的 ？ 篇新闻，这里应该设置 ?limit 参数等来控制拉取的范围，前期应该做测试，这里应该返回feedid，和对应抓取到的图片，然后让前端可以卡片页面展示    
       
    /api/v1/news/{id}   获取指定的某篇文章，应该包含点赞、转发、评论、收藏、文章这些内容


    用户有关的
    PUT /api/v1/users/{id}  邀请码对应的 id ，邀请码填入时，user 表默认应该创建一个独立 uuid，这里就对应身份页面的


    session 应该是包含多个事件的
    user_id, session_id, feedid, start_at
    
    session 事件表： feeditem id  user_id start_time end_time
    POST /api/v1/sessions (替代你设想的 /events/sessions)
    时机: 当用户首次进入实验平台，或打开一篇新的新闻文章时调用。
    功能: “我要开始一个新的阅读会话了”。
    后端操作:
    从JWT中解析出 user_id。
    创建一个新的、唯一的 session_id (通常是UUID)。
    将 user_id, session_id, article_id（如果有的话），以及当前时间（作为起始时间）记录到数据库的reading_sessions表中（这个表可以很简单，主要用于记录和分析会话）
    POST /api/v1/events (这个保持不变)
    时机: 在一个会话期间，前端定时（如每5秒）批量上报收集到的眼动、滚动等事件。
    功能: “这是刚才一段时间内，属于某个会话的事件数据”。
    关键: 前端必须在请求中明确告知这些事件属于哪个 session_id。我们稍后讨论如何发送。
    PATCH /api/v1/sessions/{session_id} (可选，用于显式结束)
    时机: 当用户关闭文章页面或浏览器标签时，前端可以在beforeunload事件中尝试调用。
    功能: “我结束了对这个会话的阅读”。
    后端操作: 在reading_sessions表中记录下结束时间。
    注意: beforeunload事件不可靠，不一定能成功发送。所以后端也需要有超时逻辑来判断会话是否已“事实结束”。


​    
    /api/v1/events/eyes				//文章持续浏览时发送的端点
    /api/v1/events/clicks
    POST /api/v1/sessions //打开一篇新文章时后端返回一个根据 user 返回的 session_id
    /api/v1/sessions/{session_id} //
    浏览一篇文章，是一个事件，点开时记录起始时间
    start_at 		同时记录
    end_at
    device_info 
    具体文章的 uuid
    对应的 session
    user_id


​    
    眼动数据是最密集的，单独存储到静态桶中
    用户浏览时一篇新闻时应该是创建了一个事件


    邀请码表
    code Primary key
    user_id
    has_recommend  是否进行被测试实验  独立出来服务来更新每天的推荐算法
    has_moreinfomation 
    
    uuid
    前端发过来的数据是 x, y 以及一个时间戳，还有 classid
    classid 应该是 4位 ，c 表示 class 的终止
    1111cx1234y1234
    classid
---

信息数据表： x，y  语义信息，点击信息，序列信息



邀请码登录： 关联 user 表， user 的外键？



user 表： 出生年月，性别， 学历，居住地，每周新闻阅读时长，经常使用的新闻平台，是否主动搜索新闻， 是否色盲，是否近视/远视，矫正视力是否正常

user 表中加入是否能看见点赞、评论、收藏。

词汇映射对应 id，分词返回



返回的新闻的顺序 id 需要记录



基于评论分词，可以考虑 gpt 生成返回



user 的推荐算法标记，外键关联？

眼动数据记录模式？

简单的分发模式 


```
NewsEyeTracking/
├── cmd/
│   └── main.go                    # 应用入口
├── internal/
│   ├── api/
│   │   ├── handlers/              # HTTP 处理器
│   │   │   ├── auth.go           # 认证相关
│   │   │   ├── user.go           # 用户管理
│   │   │   ├── news.go           # 新闻内容
│   │   │   ├── session.go        # 会话管理
│   │   │   ├── event.go          # 事件收集
│   │   │   ├── experiment.go     # 实验管理
│   │   │   ├── admin.go          # 管理功能
│   │   │   └── system.go         # 系统功能
│   │   ├── middleware/           # 中间件
│   │   │   ├── auth.go          # JWT认证
│   │   │   ├── cors.go          # 跨域处理
│   │   │   ├── logger.go        # 日志记录
│   │   │   └── error.go         # 错误处理
│   │   └── routes/              # 路由配置
│   │       └── routes.go
│   ├── service/                 # 业务逻辑层
│   │   ├── auth_service.go
│   │   ├── user_service.go
│   │   ├── news_service.go
│   │   ├── session_service.go
│   │   ├── event_service.go
│   │   ├── experiment_service.go
│   │   └── services.go          # 服务集合
│   ├── repository/              # 数据访问层
│   │   ├── user_repo.go
│   │   ├── news_repo.go
│   │   ├── session_repo.go
│   │   ├── event_repo.go
│   │   └── invitation_repo.go
│   ├── models/                  # 数据模型
│   │   ├── user.go
│   │   ├── news.go
│   │   ├── session.go
│   │   ├── event.go
│   │   └── response.go          # API响应模型
│   ├── database/                # 数据库配置
│   │   └── database.go
│   └── utils/                   # 工具函数
│       ├── jwt.go               # JWT工具
│       ├── hash.go              # 密码加密
│       ├── uuid.go              # UUID生成
│       └── validation.go        # 数据验证
├── configs/                     # 配置文件
├── migrations/                  # 数据库迁移
├── sql/                        # SQL查询文件
└── .env                        # 环境变量
```





```
-- 创建眼动事件表（高频数据，考虑分区）
CREATE TABLE eye_tracking_events (
    id              BIGSERIAL PRIMARY KEY,
    session_id      UUID NOT NULL,
    x               INTEGER NOT NULL,
    y               INTEGER NOT NULL,
    timestamp_ms    BIGINT NOT NULL,  -- 毫秒时间戳
    class_id        VARCHAR(10),      -- 文本分类ID
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    FOREIGN KEY (session_id) REFERENCES reading_sessions(id) ON DELETE CASCADE
);
```

